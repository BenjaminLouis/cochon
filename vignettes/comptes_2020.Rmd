---
title: "Compte-rendu du weekend cochon 2020"
author: "Benjamin Louis"
date: "`r format(Sys.Date(), '%d-%m-%Y')`"
output:
  pagedown::html_paged:
    css: ["default","default-fonts","custom.css"]
    self_contained: true
    toc: true
    toc_depth: 3
    md_extensions: +lists_without_preceding_blankline
  rmarkdown::html_vignette:
    toc: yes
    number_sections: yes
    css: "custom.css"
  pdf_document:
    keep_tex: yes
    latex_engine: xelatex
    toc: yes
    number_sections: yes
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  fig.align = "center",
  fig.keep = "all",
  out.width = "100%",
  dpi = 300,
  fig.asp = 0.6,
  fig.width = 6
)
library(cochon2019a)
library(tidyverse)
library(kableExtra)
library(here)
options(knitr.kable.NA = '')

# Répartition des produits
repartition <- read_csv(file.path(dirname(here()), "cochon2020","data-raw", "tableau_repartition.csv"),
                        locale = locale(decimal_mark = ","))

# Dépenses
depenses <- read_csv(file.path(dirname(here()), "cochon2020","data-raw", "depenses.csv"))

# Recettes
recettes <- read_csv(file.path(dirname(here()), "cochon2020","data-raw", "recettes.csv")) %>%
  mutate(poids_total = poids_viandes + poids_foie + poids_chair,
         prix_total = (filter(depenses, achat == "cochon") %>% pull(prix) %>% sum())*poids_total/sum(poids_total, na.rm = TRUE))

# Généralites
poids_viandes <- recettes %>% pull(poids_viandes) %>% sum(., na.rm = TRUE)
poids_chair <- recettes %>% pull(poids_chair) %>% sum(., na.rm = TRUE)
poids_foie <- recettes %>% pull(poids_foie) %>% sum(., na.rm = TRUE)
poids_total <- recettes %>% pull(poids_total) %>% sum(., na.rm = TRUE)
prix <- (filter(depenses, achat == "cochon") %>% pull(prix) %>% sum())/poids_total

gener <- tibble(
  'Nombre de cochons' = 3,
  'Poids total (kg)' = 390,
  'Prix au kilo (€/kg)' = (filter(depenses, achat == "cochon") %>% pull(prix) %>% sum())/390,
  'Prix total (€)' = (filter(depenses, achat == "cochon") %>% pull(prix) %>% sum()),
  'Poids de viande (kg)' = poids_viandes,
  'Poids de chair (kg)' = poids_chair,
  'Poids des foies (kg)' = poids_foie,
  'Poids de gras (kg)' = NA_real_,
  'Rendement sans foie (%)' = round(100*(poids_viandes + poids_chair)/390),
  'Rendement avec foie (%)' = round(100*poids_total/390),
  'Poids viandes + chair + foies (kg)' = poids_total,
  'Prix viandes + chair + foies au kilo (€/kg)' = prix
)

# Répartition des produits
coefs <- read_csv(file.path(dirname(here()), "cochon2020","data-raw", "coefs.csv"))
```

# TL;DR{-}

Vous connaissez la punition : si ça vous intéresse vous pouvez tout lire, sinon vous pouvez aller directement à la section 5 __Qui doit à qui ?__ pour savoir ce que vous devez. Les sections 1 _Bilan du weekend_ et 2 _Généralités_ peuvent éventuellement vous intéresser également sans vous assommer avec des méthodes de calcul.

# Bilan du weekend

## Déroulement du weekend

+ Mardi 22 janvier : 2 cochons mis à l'abattoir par Mickaël et Monique. un autre plus vaillant ne s'est pas fait attrapé.
+ Jeudi 23 janvier : Mickaël, Marian et Matthieu s'occuppent du dernier cochon... Leur efficacité a fait croître leur renommé dans le monde de la tuerie en tout genre. On les appelle désormais _Les 3 M_ !
+ Vendredi 24 janvier : Découpe et début de transformation
+ Samedi 25 janvier : La transformation continue
+ Dimanche 26 janvier : Dernières cuissons et ménage

Tout ce week-end a été accompagné de délicieux et conviviaux repas, merci à vous cuistos !

## Ce qui a été dit/ressenti

+ 3 cochons c'est beaucoup, peut-être trop ?

# Généralités

## Quelques chiffres sur les cochons

```{r}
tibble('Intitulé' = names(gener), Valeur = unlist(gener[1,])) %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Généralités sur les cochons") %>% 
  kable_styling(full_width = TRUE)
```

## Quelques chiffres sur les consommables utilisés

## Prix global de la viande

Pour calculer un prix pour les différentes recettes, j'ai ramené le prix de la carcasse au poids de viande + chair + foies. Le foie étant limitant, j'ai choisi de lui donner une valeur au même titre que la viande (sinon le pâté de foie ne valait rien). À noter, cette année on a pas pesé la quantité de gras.

Au final, on obtient un prix d'environ `r round(pull(gener, "Prix viandes + chair + foies au kilo (€/kg)"), 2)` €/kg. Cela correspond à 2,50€ de moins que l'année dernière (30% de réduction) pour un rendement équivalent; ce qui s'exploique par un prix de la carcasse bien plus bas (3€/kg) dont nous a fait profité Mickaël. Merci à lui.


## Répartition dans les recettes

Le tableau 2.2 donne les poids de viande, chair, foies et total qu'il y a dans chaque recette et l'équivalent en prix. Ce tableau me sert surtout pour calculer ci-après le poids unitaire des recettes en fonction de leur conditionnement. Si la case est vide, c'est que la valeur est de 0.

<div class = "break-before-me"></div>

```{r}
recettes %>% 
  mutate_if(is.numeric, ~recode(., `0` = NA_real_)) %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Poids et prix selon les recettes") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "Les poids sont en kilogramme, le prix est en €", threeparttable = T)
```

\newpage

# Prix des différentes recettes en fonction de leur conditionnement

## Méthode de calcul

De la même manière que l'année dernière, certaines données sont manquantes ou trop imprécises pour pouvoir calculer un prix exact de chaque recette. Certaines simplifications méthodologiques ont du être faites.

+ Le prix d'une recette est calculé par rapport au prix de la quantité de viande et/ou foie et/ou chair qu'elle contient

+ Le gras n'étant pas limitant il n'est pas comptabilisé (ou son prix est égal à 0€ si vous préférez). Ainsi, plus une recette contient en proportion du gras, moins elle est chère en unité de poids. He oui, le cholestérol ne vaut pas grand chose!

+ Les autres ingrédients des différentes recettes sont intégrés dans le prix total des courses du weekend qui est divisé au prorata du nombre de personnes. Le prix des ingrédients n'est donc pas contenu dans le prix des recettes.

+ De même, les boyaux sont intégrés au prix total des courses et non pas dans le prix des différentes recettes. On pourrait en théorie le faire mais les données sont trop imprécises pour que ça ait du sens. Une estimation très rapide _"à la louche"_ conduit à un prix d'environ 30 cents de boyau pour une saucisse sèche ou un saucisson, environ 20 cents de boyau pour une chipo et environ 3 cents de boyau pour une saucisse fraiche ou un boudin.

__Méthode 1__

Lorsque les recettes sont conditionnées en produit de différentes tailles, un premier calcul consiste à évaluer le prix unitaire des différents conditionnement. La taille du conditionnement donne un coefficient qui, associé à la quantité faite de chaque conditionnement et le prix total de la recette, permet de retrouver le prix unitaire. Je sais que beaucoup s'en foute, mais moi j'adore mettre des formules, alors la voici :

$$PUproduit_{ij} = \frac{coef_{ij} \times P_{total_{j}}}{\sum_{i}\left(coef_{ij} \times quantite_{ij}\right)}$$

où $PUproduit_{ij}$ est le prix unitaire du produit (ou conditionnement) $i$ d'une recette $j$, $coef_{ij}$ est le coefficient associé à ce conditionnement, $P_{total_{j}}$ est le prix de revient total de la recette $j$ (cf Tableau 2.2) et $quantite_{ij}$ est la quantité totale faite de contionnement $i$ pour la même recette $j$.

Une fois qu'on a le prix unitaire d'un conditonnement, il suffit de le multiplier par la quantité que chaque personne/famille a pris pour savoir ce que doit la personne/famille pour cette recette :

$$Prix_{jk} = \sum_{i}\left(nb_{ijk} \times PUproduit_{ij}\right)$$
où $Prix_{jk}$ est le prix que doit payer la personne/famille $k$ pour la recette $j$, $nb_{ijk}$ est le nombre du conditionnement $i$ de la recette $j$ prix par la personne/famille $k$ et $PUproduit_{ij}$ est le prix unitaire du produit (ou conditionnement) $i$ de la recette $j$.

__Méthode 2__

Si il n'y a qu'un conditionnement pour une recette, c'est directement la quantité prise par une personne/famille qui est utilisée comme coefficient associé au prix total de la recette pour calculer ce que doit la personne/famille. Ce coefficient peut être un nombre d'unité prise (e.g. j'ai pris 10 caillettes), un poids (e.g. j'ai pris 500g de chipolatas) ou une part (e.g. j'ai pris une part de jambon).

$$Prix_{jk} = \frac{w_{jk} \times P_{total_{j}}}{\sum_{k} w_{jk}}$$
où où $Prix_{jk}$ est le prix que doit payer la personne/famille $k$ pour la recette $j$, $w_{jk}$ est le coefficient représentant la quantité de la recette $j$ prise par la personne/famille $k$ et $P_{total_{j}}$ est le prix de revient total de la recette $j$ (Tableau 2.2).

Pour les plus passionnés, suspicieux, fous ou ceux qui s'ennuient, normalement vous avez tout dans ce document pour refaire les calculs et vérifier que je ne me suis pas trompé. Mais attention, les chiffres qui sont dans les tableaux peuvent avoir des décalages de quelques grammes ou centimes à cause des arrondis (j'allais pas laisser plus de deux chiffres décimaux). par contre, vous verrez qu'à la fin on tombe bien!

## Terrine et pâtés

### Pâté de foie

```{r}
pu_foie <- get_unitaire("pate_foie")
pu_foie %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Prix unitaire du pâté de foie") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "quantite et coef sont sans unité, prix_unitaire est en €/unité", threeparttable = T)
```

<div class = "break-before-me"></div>

```{r}
price_foie <- get_price("pate_foie", unit = pu_foie)
price_foie %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour le pâté de foie") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Pâté de campagne

Même travail pour le pâté de campagne avec la méthode 1.

```{r}
pu_campagne <- get_unitaire("pate_campagne")
pu_campagne %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Prix unitaire du pâté de campagne") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "quantite et coef sont sans unité, prix_unitaire est en €/unité", threeparttable = T)
```

Et le tableau des prix à payer.

```{r}
price_campagne <- get_price("pate_campagne", unit = pu_campagne)
price_campagne %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour le pâté de campagne") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Terrine au four


```{r}
pu_terrine <- recettes %>% filter(recettes == "terrine_four") %>% pull(prix_total)
price_terrine <- get_price("terrine_four", unit = pu_terrine)

price_terrine %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour la terrine au four") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Jambonneau

```{r}
pu_jambonneau <- recettes %>% filter(recettes == "jambonneau") %>% pull(prix_total)
price_jambonneau <- get_price("jambonneau", unit = pu_jambonneau)

price_jambonneau %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour le jambonneau") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```


### Rillettes

D'un commun accord, les rillettes sont considérées comme ayant un coût de viande égal à 0€ car issues de partie qui serait jetées sinon.

## Boudin

### Boudin blanc

Le boudin blanc contient de la chair. Il a été conditionné en boudin, où on considère que chaque boudin contient la même quantité de chair, où en bocaux. Pour le premier, on utilise la méthode 2 avec comme coefficients le poids de boudin pris par chaque personne/famille, et la méthode 1 pour les boudins en bocaux. Le tableau ci-dessous montre directement la somme.

```{r}
pu_boc_boudin_blanc <- get_unitaire("bocaux_boudin_blanc")
price_boc_boudin_blanc <- get_price("bocaux_boudin_blanc", unit = pu_boc_boudin_blanc)

pu_boudin_blanc <- recettes %>% filter(recettes == "boudin_blanc") %>% pull(prix_total)
price_boudin_blanc <- get_price("boudin_blanc", unit = pu_boudin_blanc)

bind_rows(price_boudin_blanc, price_boc_boudin_blanc) %>% 
  group_by(qui) %>% 
  summarize(doit_payer = sum(doit_payer, na.rm = TRUE)) %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour le boudin blanc") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Boudins noir et créole

D'un commun accord, les boudins noir et créole sont considérés comme ayant un coût de viande égal à 0€ car issus de partie qui serait jetées sinon.

## Saucisses fraiches et chipolatas

### Saucisses fraiches

Pour les saucisses fraiches, on considère que chaque saucisse contient la même quantité de viande et on utilise la méthode 2. Les saucisses mises en bocal ne sont pas comptabilisées ici.

<div class = "break-before-me"></div>

```{r}
pu_saucisses <- recettes %>% filter(recettes == "saucisses_fraiches") %>% pull(prix_total)
price_saucisses <- get_price("saucisses_fraiches", unit = pu_saucisses)

price_saucisses %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les saucisses fraiches") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Chipolatas

La méthode 2 est également utilisée ici avec comme coefficients le poids de chipolatas pris par chaque personne/famille.

```{r}
pu_chipo <- recettes %>% filter(recettes == "chipolatas") %>% pull(prix_total)
price_chipo <- get_price("chipolatas", unit = pu_chipo)

price_chipo %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les chipolatas") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Chair à saucisses

La méthode 2 est également utilisée ici avec comme coefficients le poids de chair pris par chaque personne/famille.

<div class = "break-before-me"></div>

```{r}
pu_chair <- recettes %>% filter(recettes == "chaire_fraiche") %>% pull(prix_total)
price_chair <- get_price("chaire_fraiche", unit = pu_chair)

price_chair %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour la chair à saucisses") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```


### Caillettes

La méthode 2 est également utilisée ici avec comme coefficients le poids de caillettes pris par chaque personne/famille.

```{r}
pu_caillettes <- recettes %>% filter(recettes == "caillettes") %>% pull(prix_total)
price_caillettes <- get_price("caillettes", unit = pu_caillettes)

price_caillettes %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour la chair à saucisses") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

## Saucisses sèches et saucissons

### Saucisses sèches

On considère ici aussi que chaque saucisse sèche contient la même quantité de viande et le nombre prix par chaque personne/famille sert de coefficient dans la méthode 2.

__N.B.__ à mon avis ici il y a plus de différence que pour les saucisses fraiches où les caillettes. Il serait surement plus précis les autres années de peser avant séchage chaque saucisse est de répartir directement. Cela demande un peu plus de logistique car il faut marquer chaque saucisse pour redistribuer convenablement après séchage.

```{r}
pu_saucisses_seches <- recettes %>% filter(recettes == "saucisses_seches") %>% pull(prix_total)
price_saucisses_seches  <- get_price("saucisses_seches", unit = pu_saucisses_seches)

price_saucisses_seches %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les saucisses sèches") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Saucissons

Même travail que pour les saucisses sèches avec la même remarque sur une pesée et répartition avant séchage.

```{r}
pu_saucissons <- recettes %>% filter(recettes == "saucissons") %>% pull(prix_total)
price_saucissons  <- get_price("saucissons", unit = pu_saucissons)

price_saucissons %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les saucissons") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Chorizo

Même travail que pour les saucisses sèches avec la même remarque sur une pesée et répartition avant séchage.

```{r}
pu_chorizo <- recettes %>% filter(recettes == "chorizo") %>% pull(prix_total)
price_chorizo  <- get_price("chorizo", unit = pu_chorizo)

price_chorizo %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les chorizo") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

## Bocaux viandes

### Bocaux viandes ou saucisses

Les bocaux de viande sont conditionnés en bocaux de différentes tailles avec de la viande seule, de la saucisse seule ou bien les deux. La méthode 1 est appliquée avec la petite différence qu'il faut ajouter le prix des saucisses lorsqu'il y en a.

```{r}
# 0.169kg est le poids estimées d'une saucisses fraiches
pu_bocaux_viandes <- get_unitaire("bocaux_viandes", prix_sauc = 0.169*prix)
pu_bocaux_viandes %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Prix unitaire des bocaux de viandes") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "les quantités et coefs sont sans unité, les prix sont en €/unité", threeparttable = T)
```

<div class = "break-before-me"></div>

```{r}
price_bocaux_viandes <- get_price("bocaux_viandes", unit = pu_bocaux_viandes)
price_bocaux_viandes %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les bocaux de viandes") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Bocaux jambonneaux

Méthode 2.

```{r}
pu_bocaux_jamb <-  recettes %>% filter(recettes == "bocaux_jambonneau") %>% pull(prix_total)
price_bocaux_jamb <- get_price("bocaux_jambonneau", unit = pu_bocaux_jamb)
price_bocaux_jamb %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les bocaux de viandes") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

<div class = "break-before-me"></div>

## Viandes fraiches

### Côte de porc

La méthode 2 est appliquée avec comme coeffficients les poids pris par chacun.

```{r}
pu_cote_de_porc <- recettes %>% filter(recettes == "cote_de_porc") %>% pull(prix_total)
price_cote_de_porc  <- get_price("cote_de_porc", unit = pu_cote_de_porc)

price_cote_de_porc %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les côtes de porc") %>% 
  kable_styling(full_width = TRUE) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Rouelle

La méthode 2 est appliquée avec comme coeffficients les poids pris par chacun.

```{r}
pu_rouelle <- recettes %>% filter(recettes == "rouelle") %>% pull(prix_total)
price_rouelle  <- get_price("rouelle", unit = pu_rouelle)

price_rouelle %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les rouelles") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Roti

La méthode 2 est appliquée avec comme coeffficients les poids pris par chacun.

```{r}
pu_roti <- recettes %>% filter(recettes == "roti") %>% pull(prix_total)
price_roti  <- get_price("roti_saute", unit = pu_roti)

price_roti %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les rotis") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Filet mignon

La méthode 2 est appliquée avec comme coeffficients les poids pris par chacun.

```{r}
pu_filet_mignon <- recettes %>% filter(recettes == "filet_mignon") %>% pull(prix_total)
price_filet_mignon  <- get_price("filet_mignon", unit = pu_filet_mignon)

price_filet_mignon %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les filets mignons") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

<div class = "break-before-me"></div>

### Ribs

La méthode 2 est appliquée avec comme coeffficients les poids pris par chacun..

```{r}
pu_ribs <- recettes %>% filter(recettes == "ribs") %>% pull(prix_total)
price_ribs  <- get_price("ribs", unit = pu_ribs)

price_ribs %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour les ribs") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Lard frais

La méthode 2 est appliquée avec comme coeffficients les poids pris par chacun.

```{r}
pu_lard <- recettes %>% filter(recettes == "lard_frais") %>% pull(prix_total)
price_lard  <- get_price("lard_frais", unit = pu_lard)

price_lard %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour le lard frais") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

<div class = "break-before-me"></div>

## Viandes sèches

### ventreche

On divisera la ventreche équitablement entre les 8 familles présentes.

```{r}
pu_ventreche <- recettes %>% filter(recettes == "ventreche") %>% pull(prix_total)
price_ventreche  <- get_price("ventreche", unit = pu_ventreche)

price_ventreche %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour la ventreche") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

### Jambon

On divisera le jambon équitablement entre les 8 familles présentes.

```{r}
pu_jambon <- recettes %>% filter(recettes == "jambon") %>% pull(prix_total)
price_jambon  <- get_price("jambon", unit = pu_jambon)

price_jambon %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour le jambon") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```


### Autre viande séchée

On divisera les autres morceaux de viande séchée équitablement entre les 8 familles présentes.

```{r}
pu_autres <- recettes %>% filter(recettes == "autres_viandes_seches") %>% pull(prix_total)
price_autre <- get_price("autres_viandes_seches", unit = pu_autres)

price_autre %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût par personne/famille pour le jambon") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

\newpage

# Prix à payer par personne

## La viande

Une fois qu'on a fait le calcul pour toutes les recettes, pour connaître ce que doit la personne/famille $k$, il suffit de sommer l'ensemble de ce qu'elle doit pour chaque recette.

$$Prix_{k} = \sum_{i} Prix_{jk}$$
où $Prix_{k}$ est le prix que doit la personne/famille $k$ pour l'ensemble des recettes.

```{r}
all_prices <- bind_rows(
  mutate(price_foie, recettes = "pate_foie"),
  mutate(price_campagne, recettes = "pate_campagne"),
  mutate(price_terrine, recettes = "pate_terrine_four"),
  mutate(price_jambonneau, recettes = "jambonneau"),
  mutate(price_boudin_blanc, recettes = "boudin_blanc"),
  mutate(price_boc_boudin_blanc, recettes = "bocaux_boudin_blanc"),
  mutate(price_saucisses, recettes = "saucisses_fraiches"),
  mutate(price_chipo, recettes = "chipolatas"),
  mutate(price_chair, recettes = "chair"),
  mutate(price_caillettes, recettes = "caillettes"),
  mutate(price_saucisses_seches, recettes = "saucisses_seches"),
  mutate(price_saucissons, recettes = "saucissons"),
  mutate(price_chorizo, recettes = "chorizo"),
  mutate(price_bocaux_viandes, recettes = "bocaux_viandes"),
  mutate(price_bocaux_jamb, recettes = "bocaux_jambonneau"),
  mutate(price_cote_de_porc, recettes = "cote_de_porc"),
  mutate(price_rouelle, recettes = "rouelle"),
  mutate(price_roti, recettes = "roti"),
  mutate(price_filet_mignon, recettes = "filet_mignon"),
  mutate(price_ribs, recettes = "ribs"),
  mutate(price_lard, recettes = "poitrine"),
  mutate(price_ventreche, recettes = "ventreche"),
  mutate(price_jambon, recettes = "jambon"),
  mutate(price_autre, recettes = "autres_viandes_seches")
) %>% 
  select(recettes, qui, doit_payer) %>% 
  group_by(qui) %>% 
  summarise(doit_payer = sum(doit_payer, na.rm = TRUE))

all_prices %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût total par personne/famille pour la viande") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```


## Achats commun

```{r}
price_commun <- bind_rows(
  depenses %>%
    filter(achat != "cochon") %>%
    select(-acheteur) %>% 
    group_by(achat) %>% 
    summarise(cout = sum(prix)),
  all_prices %>% 
    filter(qui %in% c("commun", "dons", "casse")) %>% 
    rename(achat = qui, cout = doit_payer) %>% 
    mutate(achat = paste0("cochon_", achat))
)
price_commun_total <- pull(price_commun, cout) %>% sum

price_commun %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Résumé des dépenses communes") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "cout est en €", threeparttable = T)
```

Le tableau 4.2 résume les achats communs, toutes personnes/familles confondues. Sont ajoutés dedans le coût de revient de la viande en commun i.e. celle mangée ensemble (`commun`), celle donnée (`dons`) et la casse qu'il y a eu (`casse`).

Le coût de ces achats communs sont répartis entre les personnes/familles au prorata du nombre de personnes, les enfants n'étant pas comptés (la SCI non plus acr elle ne représente pas une personne physique présente).

```{r}
all_commun <- all_prices %>% 
  filter(!qui %in% c("commun", "dons", "casse")) %>% 
  select(-doit_payer) %>% 
  mutate(nb_personne = c(2,2,2,2,1,0,2,2,1)) %>% 
  mutate(doit_payer = nb_personne*price_commun_total/sum(nb_personne)) %>% 
  select(-nb_personne) 
all_commun %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût total par personne/famille pour les dépenses communes") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

## Total

Pour savoir ce que doit payer chaque personne/famille, on somme le coût de la viande pris par chacun et le coût des dépenses communes que doit chacun pour obtenir le tableau 4.4.

```{r}
total_prices <- bind_rows(
  all_prices %>% 
    filter(!qui %in% c("commun", "dons", "casse")), 
  all_commun
  ) %>% 
  group_by(qui) %>% 
  summarise(doit_payer = sum(doit_payer))
total_prices %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Coût total par personne/famille pour le weekend") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "doit_payer est en €", threeparttable = T)
```

\newpage

# Qui doit à qui ?

Le tableau 5.1 fait un bilan de ce que chacun a payé, ce que chacun doit payer et la différence entre ce que chacun doit payer et ce que chacun a payé. En gros, si c'est positif, c'est la somme que vous devez, si c'est négatif, c'est la somme qu'on vous doit. Donc tout le monde doit de l'argent à Steph&Luc, à Clément et au Mazel.

Je propose ici que tout le monde donne ce qu'il doit à Steph&Luc et que ces derniers remboursent Clément et le Mazel.

```{r}
bilan <- full_join(
  rename(depenses, qui = acheteur) %>% 
    group_by(qui) %>% 
    summarize(a_paye = sum(prix)),
  total_prices,
  by = "qui"
) %>% 
  mutate(a_paye = ifelse(is.na(a_paye), 0, a_paye),
         doit_payer = ifelse(is.na(doit_payer), 0, doit_payer)) %>% 
  mutate(difference = doit_payer - a_paye)
bilan %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Net à payer ou à recevoir par personne/famille") %>% 
  kable_styling(latex_options = c("hold_position")) %>%
  footnote(general = "a_paye, doit_payer et difference sont en €", threeparttable = T)
```



# Annexe{-}

<iframe>

```{r}
repartition %>% 
  #select(-recettes) %>% 
  kable(format = "html", escape = FALSE,
        digits = 2, caption = "Tableau des répartitions des recettes entre les personnes/familles") %>% 
  kable_styling(full_width = TRUE) #%>%
  #footnote(general = "Les pâtés de foie, de campagne, rilletes, saucisses fraiches, caillettes, saucisses sèches, saucissons, chorizos, boudins, bocaux de viandes, de jambonneau et les poitrines sont en unité (ou pièce); le jambonneau, la terrine au four, le jambon et les autres morceaux de viandes séchés sont en part; les chipolatas, côtes de porc, rouelles, rotis, filets mignon et ribs sont en grammes.", threeparttable = T) 
```

</iframe>
